-- Normal Script: ServerScriptService/NoxiaLogs/MainScript
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

-- Config modÃ¼lÃ¼nÃ¼ yÃ¼kle
local Config = require(script.Parent.Config)

-- Global deÄŸiÅŸkenler
_G.NoxiaLogs = {
	SystemInfo = {
		Name = Config.SystemName,
		Version = Config.Version,
		Status = "Active"
	},
	Stats = {
		TotalLogsSent = 0,
		LastError = nil,
		StartupTime = os.time()
	}
}

-- Utility fonksiyonlar
local function formatTimestamp()
	local currentTime = os.date("*t")
	return string.format("%02d/%02d/%04d %02d:%02d:%02d", 
		currentTime.day, currentTime.month, currentTime.year,
		currentTime.hour, currentTime.min, currentTime.sec)
end

-- Webhook gÃ¶nderme fonksiyonu
local function SendWebhook(webhookType, embedData)
	if not Config.Enabled then 
		if Config.DebugMode then
			print("âŒ NoxiaLogs: Sistem devre dÄ±ÅŸÄ±")
		end
		return false 
	end

	-- Config'ten webhook URL'sini Ã§ek
	local webhookUrl = Config.Webhooks[webhookType]

	if Config.DebugMode then
		print("ğŸ” NoxiaLogs Debug:")
		print("Webhook Type: " .. webhookType)
		print("Webhook URL: " .. tostring(webhookUrl))
	end

	if not webhookUrl or webhookUrl == "" or string.find(webhookUrl, "your_webhook_url") then
		warn("âŒ NoxiaLogs: " .. webhookType .. " webhook URL'si ayarlanmamÄ±ÅŸ")
		return false
	end

	local data = {
		embeds = {embedData}
	}

	local success, result = pcall(function()
		local jsonData = HttpService:JSONEncode(data)
		if Config.DebugMode then
			print("ğŸ“¤ NoxiaLogs: Webhook gÃ¶nderiliyor...")
		end
		return HttpService:PostAsync(webhookUrl, jsonData, Enum.HttpContentType.ApplicationJson)
	end)

	if success then
		_G.NoxiaLogs.Stats.TotalLogsSent += 1
		if Config.DebugMode then
			print("âœ… NoxiaLogs: " .. webhookType .. " webhook'u baÅŸarÄ±yla gÃ¶nderildi")
			print("ğŸ“Š Toplam gÃ¶nderilen log: " .. _G.NoxiaLogs.Stats.TotalLogsSent)
		end
	else
		warn("âŒ NoxiaLogs Webhook Error (" .. webhookType .. "): " .. tostring(result))
	end

	return success
end

-- Sohbet Log Fonksiyonu
function _G.NoxiaLogs_LogChat(player, message)
	if not Config.ChatLog.Enabled then 
		if Config.DebugMode then
			print("âŒ NoxiaLogs: Sohbet log devre dÄ±ÅŸÄ±")
		end
		return 
	end

	if Config.DebugMode then
		print("ğŸ” NoxiaLogs: Sohbet log baÅŸlatÄ±lÄ±yor...")
		print("Oyuncu: " .. player.Name)
		print("Mesaj: " .. message)
	end

	-- Filtreleme kontrolÃ¼
	if Config.ChatLog.IgnoreList and table.find(Config.ChatLog.IgnoreList, player.UserId) then 
		if Config.DebugMode then
			print("âŒ NoxiaLogs: Oyuncu ignore list'te")
		end
		return 
	end

	if Config.ChatLog.FilterBadWords and Config.ChatLog.BadWordsList then
		for _, badWord in ipairs(Config.ChatLog.BadWordsList) do
			if string.lower(message):find(string.lower(badWord)) then
				if Config.DebugMode then
					print("âŒ NoxiaLogs: KÃ¶tÃ¼ kelime filtrelendi")
				end
				return
			end
		end
	end

	local embed = {
		title = "ğŸ’¬ Sohbet MesajÄ±",
		color = Config.Colors.Chat,
		fields = {
			{
				name = "ğŸ‘¤ KullanÄ±cÄ±",
				value = player.Name,
				inline = true
			},
			{
				name = "ğŸ†” Roblox ID",
				value = tostring(player.UserId),
				inline = true
			},
			{
				name = "ğŸ“ Mesaj",
				value = message,
				inline = false
			},
			{
				name = "ğŸ• Zaman",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	if Config.DebugMode then
		print("ğŸ“¨ NoxiaLogs: Sohbet embed hazÄ±r, gÃ¶nderiliyor...")
	end

	return SendWebhook("Chat", embed)
end

-- GiriÅŸ Log Fonksiyonu
function _G.NoxiaLogs_LogJoin(player)
	if not Config.JoinLeaveLog.Enabled then 
		if Config.DebugMode then
			print("âŒ NoxiaLogs: GiriÅŸ log devre dÄ±ÅŸÄ±")
		end
		return 
	end

	if Config.DebugMode then
		print("ğŸ” NoxiaLogs: GiriÅŸ log baÅŸlatÄ±lÄ±yor...")
		print("Oyuncu: " .. player.Name)
	end

	local accountAge = player.AccountAge
	local profileLink = "https://www.roblox.com/users/" .. player.UserId .. "/profile"
	local warnings = ""

	if Config.JoinLeaveLog.WarnNewAccounts and accountAge < Config.JoinLeaveLog.NewAccountThreshold then
		warnings = "ğŸš¨ **YENÄ° HESAP UYARISI:** " .. accountAge .. " gÃ¼nlÃ¼k hesap\n"
	end

	local embed = {
		title = "âœ… Oyuncu GiriÅŸ YaptÄ±",
		color = Config.Colors.Join,
		description = warnings,
		fields = {
			{
				name = "ğŸ‘¤ KullanÄ±cÄ±",
				value = player.Name,
				inline = true
			},
			{
				name = "ğŸ†” Roblox ID",
				value = tostring(player.UserId),
				inline = true
			},
			{
				name = "ğŸ“… Hesap YaÅŸÄ±",
				value = accountAge .. " gÃ¼n",
				inline = true
			},
			{
				name = "ğŸ• GiriÅŸ ZamanÄ±",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	if Config.JoinLeaveLog.ShowProfileLinks then
		table.insert(embed.fields, 4, {
			name = "ğŸ”— Profil",
			value = "[Profil Linki](" .. profileLink .. ")",
			inline = false
		})
	end

	if Config.DebugMode then
		print("ğŸ“¨ NoxiaLogs: GiriÅŸ embed hazÄ±r, gÃ¶nderiliyor...")
	end

	return SendWebhook("JoinLeave", embed)
end

-- Ã‡Ä±kÄ±ÅŸ Log Fonksiyonu
function _G.NoxiaLogs_LogLeave(player)
	if not Config.JoinLeaveLog.Enabled then 
		if Config.DebugMode then
			print("âŒ NoxiaLogs: Ã‡Ä±kÄ±ÅŸ log devre dÄ±ÅŸÄ±")
		end
		return 
	end

	if Config.DebugMode then
		print("ğŸ” NoxiaLogs: Ã‡Ä±kÄ±ÅŸ log baÅŸlatÄ±lÄ±yor...")
		print("Oyuncu: " .. player.Name)
	end

	local accountAge = player.AccountAge
	local profileLink = "https://www.roblox.com/users/" .. player.UserId .. "/profile"

	local embed = {
		title = "âŒ Oyuncu Ã‡Ä±kÄ±ÅŸ YaptÄ±",
		color = Config.Colors.Leave,
		fields = {
			{
				name = "ğŸ‘¤ KullanÄ±cÄ±",
				value = player.Name,
				inline = true
			},
			{
				name = "ğŸ†” Roblox ID",
				value = tostring(player.UserId),
				inline = true
			},
			{
				name = "ğŸ“… Hesap YaÅŸÄ±",
				value = accountAge .. " gÃ¼n",
				inline = true
			},
			{
				name = "ğŸ• Ã‡Ä±kÄ±ÅŸ ZamanÄ±",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	if Config.JoinLeaveLog.ShowProfileLinks then
		table.insert(embed.fields, 4, {
			name = "ğŸ”— Profil",
			value = "[Profil Linki](" .. profileLink .. ")",
			inline = false
		})
	end

	if Config.DebugMode then
		print("ğŸ“¨ NoxiaLogs: Ã‡Ä±kÄ±ÅŸ embed hazÄ±r, gÃ¶nderiliyor...")
	end

	return SendWebhook("JoinLeave", embed)
end

-- Hata Log Fonksiyonu
function _G.NoxiaLogs_LogError(errorType, errorMessage, player)
	if not Config.ErrorLog.Enabled then return end

	local embed = {
		title = "âš ï¸ Sistem HatasÄ±",
		color = Config.Colors.Error,
		fields = {
			{
				name = "ğŸ”§ Hata TÃ¼rÃ¼",
				value = errorType,
				inline = true
			},
			{
				name = "ğŸ“ Hata MesajÄ±",
				value = "```" .. tostring(errorMessage) .. "```",
				inline = false
			},
			{
				name = "ğŸ• Zaman",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	if player then
		table.insert(embed.fields, 1, {
			name = "ğŸ‘¤ KullanÄ±cÄ±",
			value = player.Name .. " (ID: " .. player.UserId .. ")",
			inline = true
		})
	end

	return SendWebhook("Errors", embed)
end

-- Data Log Fonksiyonu
function _G.NoxiaLogs_LogData(action, player, details)
	if not Config.DataLog.Enabled then return end

	local embed = {
		title = "ğŸ’¾ Data Ä°ÅŸlemi",
		color = Config.Colors.Data,
		fields = {
			{
				name = "ğŸ”§ Ä°ÅŸlem",
				value = action,
				inline = true
			},
			{
				name = "ğŸ‘¤ KullanÄ±cÄ±",
				value = player and player.Name .. " (ID: " .. player.UserId .. ")" or "Sistem",
				inline = true
			},
			{
				name = "ğŸ“ Detaylar",
				value = tostring(details),
				inline = false
			},
			{
				name = "ğŸ• Zaman",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	return SendWebhook("Data", embed)
end

-- Performans Log Fonksiyonu
function _G.NoxiaLogs_LogPerformance(stats, isEmergency)
	if not Config.PerformanceLog.Enabled then return end

	local color = isEmergency and Config.Colors.Error or Config.Colors.Performance

	local embed = {
		title = "ğŸ“Š Performans Raporu",
		color = color,
		fields = {
			{
				name = "ğŸ‘¥ Oyuncu SayÄ±sÄ±",
				value = stats.playerCount .. "/" .. stats.maxPlayers,
				inline = true
			},
			{
				name = "âš¡ FPS",
				value = tostring(stats.averageFPS),
				inline = true
			},
			{
				name = "ğŸ’¾ Memory",
				value = stats.totalMemory .. "MB",
				inline = true
			},
			{
				name = "ğŸ• Zaman",
				value = formatTimestamp(),
				inline = false
			}
		},
		footer = {
			text = Config.SystemName .. " " .. Config.Version
		}
	}

	if isEmergency then
		embed.description = "ğŸš¨ ACÄ°L PERFORMANS UYARISI"
	end

	return SendWebhook("Performance", embed)
end

-- Otomatik giriÅŸ-Ã§Ä±kÄ±ÅŸ loglama
Players.PlayerAdded:Connect(function(player)
	_G.NoxiaLogs_LogJoin(player)
end)

Players.PlayerRemoving:Connect(function(player)
	_G.NoxiaLogs_LogLeave(player)
end)

-- Otomatik sohbet loglama
local function onPlayerAdded(player)
	player.Chatted:Connect(function(message)
		_G.NoxiaLogs_LogChat(player, message)
	end)
end

Players.PlayerAdded:Connect(onPlayerAdded)

-- Zaten oyunda olan oyuncular iÃ§in
for _, player in ipairs(Players:GetPlayers()) do
	onPlayerAdded(player)
end

-- Sistem baÅŸlatma mesajÄ±
print("ğŸš€ Noxia Logs Systems " .. Config.Version .. " baÅŸlatÄ±ldÄ±!")
print("ğŸ“Š Aktif modÃ¼ller:")
print("   âœ… Sohbet Log: " .. tostring(Config.ChatLog.Enabled))
print("   âœ… GiriÅŸ-Ã‡Ä±kÄ±ÅŸ Log: " .. tostring(Config.JoinLeaveLog.Enabled))
print("   âœ… Hata Log: " .. tostring(Config.ErrorLog.Enabled))
print("   âœ… Data Log: " .. tostring(Config.DataLog.Enabled))
print("   âœ… Performans Log: " .. tostring(Config.PerformanceLog.Enabled))

-- Test mesajÄ± (opsiyonel)
if Config.DebugMode then
	wait(5)
	print("ğŸ§ª NoxiaLogs: Test loglarÄ± gÃ¶nderiliyor...")

	local testPlayer = {
		Name = "TestPlayer",
		UserId = 123456,
		AccountAge = 5
	}

	_G.NoxiaLogs_LogChat(testPlayer, "Sistem test mesajÄ±!")
	_G.NoxiaLogs_LogJoin(testPlayer)
end
